<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>钱包连接演示 - 支持中英切换</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      color: #e2e8f0;
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }

    header {
      position: fixed;
      top: 16px;
      right: 24px;
      z-index: 1000;
      display: flex;
      gap: 10px;
    }

    .btn {
      height: 44px;
      padding: 0 18px;
      border: none;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.25s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
      min-width: 70px;
    }

    .lang-btn {
      background: rgba(59,130,246,0.28);
      color: #93c5fd;
      border: 1px solid rgba(147,197,253,0.35);
    }

    .lang-btn:hover {
      background: rgba(59,130,246,0.45);
      border-color: #60a5fa;
    }

    .lang-btn.active {
      background: #3b82f6;
      color: white;
      border: none;
      box-shadow: 0 6px 16px rgba(59,130,246,0.5);
    }

    #walletBtn {
      background: linear-gradient(135deg, #3b82f6, #60a5fa);
      color: white;
      gap: 10px;
      padding: 0 20px;
      min-width: 160px;
    }

    #walletBtn:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 20px rgba(59,130,246,0.6);
    }

    #walletBtn.connected {
      background: linear-gradient(135deg, #10b981, #34d399);
    }

    #walletBtn svg {
      width: 20px;
      height: 20px;
      stroke: currentColor;
      stroke-width: 2.2;
    }

    /* 弹窗 */
    #modalOverlay {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.8);
      backdrop-filter: blur(6px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }

    #modalContent {
      background: #1e293b;
      padding: 32px 28px;
      border-radius: 20px;
      max-width: 420px;
      width: 90%;
      box-shadow: 0 20px 50px rgba(0,0,0,0.6);
      border: 1px solid rgba(255,255,255,0.08);
      position: relative;
    }

    #closeModal {
      position: absolute;
      top: 16px;
      right: 20px;
      font-size: 28px;
      cursor: pointer;
      color: #94a3b8;
    }

    #closeModal:hover { color: white; }

    h2 {
      margin: 0 0 24px;
      color: #93c5fd;
      text-align: center;
    }

    #status {
      min-height: 90px;
      padding: 16px;
      background: #334155;
      border-radius: 12px;
      margin: 16px 0;
      white-space: pre-wrap;
      word-break: break-all;
    }

    .action-btn {
      width: 100%;
      padding: 14px;
      margin: 10px 0;
      font-size: 1rem;
      font-weight: 600;
      border: none;
      border-radius: 12px;
      cursor: pointer;
    }

    .connect-btn { background: #3b82f6; color: white; }
    .connect-btn:hover { background: #2563eb; }
    .sign-btn    { background: #8b5cf6; color: white; }
    .sign-btn:hover    { background: #7c3aed; }
    .disconnect-btn { background: #ef4444; color: white; }
    .disconnect-btn:hover { background: #dc2626; }

    .install-hint {
      text-align: center;
      color: #fbbf24;
      margin: 20px 0;
      font-size: 0.95rem;
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
</head>
<body>

<header>
  <button class="btn lang-btn active" data-lang="zh">中</button>
  <button class="btn lang-btn" data-lang="en">EN</button>
  <button id="walletBtn" class="btn">
    <svg viewBox="0 0 24 24" fill="none">
      <path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/>
      <path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/>
      <path d="M18 12a2 2 0 0 0 0 4h4v-4z"/>
    </svg>
    <span id="walletLabel">连接钱包</span>
  </button>
</header>

<div id="modalOverlay">
  <div id="modalContent">
    <span id="closeModal">×</span>
    <h2 id="modalTitle">钱包</h2>
    <div id="status"></div>
    <div id="actionArea"></div>
  </div>
</div>

<script>
// ──────────────────────────────
// 多语言表
// ──────────────────────────────
const texts = {
  zh: {
    wallet: "钱包",
    connect: "连接钱包",
    signing: "正在请求签名...",
    sign: "签名一条消息",
    disconnect: "断开连接",
    connected: "已连接",
    address: "地址：",
    chainId: "链ID：",
    noMetaMask: "未检测到 MetaMask",
    noOKX: "未检测到欧意钱包 (OKX Wallet)",
    installMetaMask: "请先安装 MetaMask 浏览器扩展",
    installOKX: "请先安装欧意钱包扩展",
    downloadMetaMask: "下载 MetaMask",
    downloadOKX: "下载欧意钱包",
    disconnectMsg: "已断开连接",
    signSuccess: "签名成功",
    message: "消息内容：",
    signature: "签名结果：",
    signFail: "签名失败："
  },
  en: {
    wallet: "Wallet",
    connect: "Connect Wallet",
    signing: "Requesting signature...",
    sign: "Sign Message",
    disconnect: "Disconnect",
    connected: "Connected",
    address: "Address: ",
    chainId: "Chain ID: ",
    noMetaMask: "MetaMask not detected",
    noOKX: "OKX Wallet not detected",
    installMetaMask: "Please install MetaMask extension first",
    installOKX: "Please install OKX Wallet extension first",
    downloadMetaMask: "Download MetaMask",
    downloadOKX: "Download OKX Wallet",
    disconnectMsg: "Disconnected",
    signSuccess: "Signature Successful",
    message: "Message:",
    signature: "Signature:",
    signFail: "Signature failed:"
  }
};

let currentLang = 'zh';
let userAddress = null;
let web3 = null;

// ──────────────────────────────
// 语言切换
// ──────────────────────────────
function setLang(lang) {
  currentLang = lang;
  document.querySelectorAll('.lang-btn').forEach(b => {
    b.classList.toggle('active', b.dataset.lang === lang);
  });
  updateWalletLabel();
  if (document.getElementById('modalOverlay').style.display === 'flex') {
    renderModal();
  }
}

function updateWalletLabel() {
  const label = document.getElementById('walletLabel');
  if (userAddress) {
    label.textContent = `${userAddress.slice(0,4)}...${userAddress.slice(-4)}`;
  } else {
    label.textContent = texts[currentLang].connect;
  }
}

// ──────────────────────────────
// 弹窗相关
// ──────────────────────────────
const modal = document.getElementById('modalOverlay');
const statusEl = document.getElementById('status');
const actionArea = document.getElementById('actionArea');
const modalTitle = document.getElementById('modalTitle');

function showModal() {
  modal.style.display = 'flex';
  renderModal();
}

function hideModal() {
  modal.style.display = 'none';
}

function setStatus(html, className = '') {
  statusEl.innerHTML = html;
  statusEl.className = className;
}

function renderModal() {
  const txt = texts[currentLang];
  modalTitle.textContent = txt.wallet;
  actionArea.innerHTML = '';

  // 优先检查 OKX Wallet (window.okxwallet)
  if (window.okxwallet) {
    setStatus(`<div style="color:#34d399">已检测到欧意钱包 (OKX Wallet)</div>`, 'success');

    if (userAddress) {
      web3.eth.getChainId().then(id => {
        setStatus(`${txt.connected}<br>${txt.address}${userAddress}<br>${txt.chainId}${id}`, 'success');
      }).catch(() => {});

      const signBtn = document.createElement('button');
      signBtn.className = 'action-btn sign-btn';
      signBtn.textContent = txt.sign;
      signBtn.onclick = signMessage;
      actionArea.appendChild(signBtn);

      const discBtn = document.createElement('button');
      discBtn.className = 'action-btn disconnect-btn';
      discBtn.textContent = txt.disconnect;
      discBtn.onclick = disconnectWallet;
      actionArea.appendChild(discBtn);
    } else {
      const connBtn = document.createElement('button');
      connBtn.className = 'action-btn connect-btn';
      connBtn.textContent = txt.connect;
      connBtn.onclick = connectWallet;
      actionArea.appendChild(connBtn);
    }
    return;
  }

  // 如果没有 OKX，再检查 MetaMask (window.ethereum)
  if (window.ethereum) {
    setStatus(`<div style="color:#34d399">已检测到 MetaMask</div>`, 'success');

    if (userAddress) {
      web3.eth.getChainId().then(id => {
        setStatus(`${txt.connected}<br>${txt.address}${userAddress}<br>${txt.chainId}${id}`, 'success');
      }).catch(() => {});

      const signBtn = document.createElement('button');
      signBtn.className = 'action-btn sign-btn';
      signBtn.textContent = txt.sign;
      signBtn.onclick = signMessage;
      actionArea.appendChild(signBtn);

      const discBtn = document.createElement('button');
      discBtn.className = 'action-btn disconnect-btn';
      discBtn.textContent = txt.disconnect;
      discBtn.onclick = disconnectWallet;
      actionArea.appendChild(discBtn);
    } else {
      const connBtn = document.createElement('button');
      connBtn.className = 'action-btn connect-btn';
      connBtn.textContent = txt.connect;
      connBtn.onclick = connectWallet;
      actionArea.appendChild(connBtn);
    }
    return;
  }

  // 两者都没有
  setStatus(`
    <div style="color:#f87171">${txt.noOKX}</div>
    <div class="install-hint">
      ${txt.installOKX}<br>
      <a href="https://www.okx.com/web3" target="_blank" style="color:#60a5fa">
        ${txt.downloadOKX}
      </a>
    </div>
    <div style="margin-top:12px; opacity:0.7">
      或安装 MetaMask<br>
      <a href="https://metamask.io/download/" target="_blank" style="color:#93c5fd">
        下载 MetaMask
      </a>
    </div>
  `, 'error');
}

// ──────────────────────────────
// 钱包操作函数（保持不变）
// ──────────────────────────────
async function connectWallet() {
  try {
    setStatus(texts[currentLang].signing.replace('签名', '连接'), 'success');
    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
    userAddress = accounts[0];
    web3 = new Web3(window.ethereum);
    updateWalletLabel();
    renderModal();
  } catch (e) {
    setStatus(`连接失败：${e.message || '已取消'}`, 'error');
  }
}

async function signMessage() {
  if (!userAddress) return;
  try {
    setStatus(texts[currentLang].signing, 'success');
    const msg = `Sign this message to verify\nAddress: ${userAddress}\nTime: ${new Date().toLocaleString()}`;
    const hex = web3.utils.utf8ToHex(msg);
    const sig = await window.ethereum.request({
      method: 'personal_sign',
      params: [hex, userAddress]
    });
    setStatus(`
      ${texts[currentLang].signSuccess}<br><br>
      ${texts[currentLang].message}<br><code>${msg}</code><br><br>
      ${texts[currentLang].signature}<br><code style="word-break:break-all;">${sig}</code>
    `, 'success');
  } catch (e) {
    setStatus(`${texts[currentLang].signFail}${e.message || '已取消'}`, 'error');
  }
}

async function disconnectWallet() {
  try {
    await window.ethereum.request({
      method: 'wallet_revokePermissions',
      params: [{ eth_accounts: {} }]
    }).catch(() => {});
  } catch {}
  userAddress = null;
  web3 = null;
  updateWalletLabel();
  renderModal();
  setStatus(texts[currentLang].disconnectMsg, 'success');
}

// ──────────────────────────────
// 事件绑定
// ──────────────────────────────
document.getElementById('walletBtn').onclick = showModal;
document.getElementById('closeModal').onclick = hideModal;
modal.onclick = e => { if (e.target === modal) hideModal(); };

document.querySelectorAll('.lang-btn').forEach(btn => {
  btn.onclick = () => setLang(btn.dataset.lang);
});

if (window.ethereum) {
  window.ethereum.on('accountsChanged', acc => {
    userAddress = acc.length ? acc[0] : null;
    updateWalletLabel();
    if (modal.style.display === 'flex') renderModal();
  });
  window.ethereum.on('chainChanged', () => location.reload());

  // 检查是否已连接
  window.ethereum.request({ method: 'eth_accounts' })
    .then(acc => {
      if (acc.length) {
        userAddress = acc[0];
        web3 = new Web3(window.ethereum);
        updateWalletLabel();
      }
    });
}

// 初始化
updateWalletLabel();
</script>

</body>
</html>
